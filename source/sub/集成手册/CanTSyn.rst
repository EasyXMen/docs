================
CanTSyn
================

ç›®æ ‡
====

æœ¬é›†æˆæ‰‹å†Œç”¨äºæŒ‡å¯¼å®¢æˆ·è¿›è¡ŒCanTSyné›†æˆï¼Œæ–‡æ¡£ä¸»è¦åŒ…æ‹¬çš„å†…å®¹ä¸ºï¼šåè®®æ ˆé›†æˆæŒ‡å¯¼ã€åŸºäºæ™®é€šåº”ç”¨çš„é›†æˆç¤ºä¾‹è®²è§£ã€‚

ç”±äºå„é¡¹ç›®çš„éœ€æ±‚ä¸åŒï¼Œé›†æˆç¤ºä¾‹ä¸ä¼šé’ˆå¯¹äºç‰¹å®šçš„å•†ä¸šé¡¹ç›®åšè¯¦ç»†è®²è§£ã€‚

ç¼©å†™è¯å’Œæœ¯è¯­
============

è¡¨  ç¼©å†™è¯å’Œæœ¯è¯­

+-----------------+------------------------------------------------------+
| **ç¼©å†™è¯/æœ¯è¯­** | **æè¿°**                                             |
+=================+======================================================+
| CanIf           | Can Interface Cané€šä¿¡çš„æ¥å£æ¨¡å—                      |
+-----------------+------------------------------------------------------+
| CanTSyn         | TimeSyncOverCAN CANæ—¶é—´åŒæ­¥æ¨¡å—                      |
+-----------------+------------------------------------------------------+
| StbM            | SynchronizedTimeBaseManager åŒæ­¥æ—¶åŸºç®¡ç†å™¨           |
+-----------------+------------------------------------------------------+

å‚è€ƒæ–‡æ¡£
========

[1] å‚è€ƒæ‰‹å†Œ_CanTSyn.pdf

[2] å‚è€ƒæ‰‹å†Œ_StbM.pdf

åè®®æ ˆé›†æˆ
==========

é¡¹ç›®äº¤ä»˜çš„å†…å®¹ä¸ºï¼šCanTSynåè®®æ ˆæºç å’ŒORIENTAIS
Studioé…ç½®å·¥å…·ã€‚åè®®æ ˆç»†åˆ†ä¸ºåè®®æ ˆçš„å„æ¨¡å—åŠå…¶å¯¹åº”çš„é…ç½®å·¥å…·æ¨¡å—ã€‚

CanTSynåè®®æ ˆå„é…ç½®æ¨¡å—çš„åŠŸèƒ½ä»‹ç»ã€‚

ä½¿ç”¨åè®®æ ˆæºç å’Œé…ç½®å·¥å…·ï¼Œè¿›è¡Œåè®®æ ˆçš„é›†æˆçš„æ­¥éª¤ã€‚

è¡¨ CanTSynåè®®æ ˆå„é…ç½®æ¨¡å—ä»‹ç»

+------------+-----------------------------------------------------------------------------------------------------+
| **æ¨¡å—å** | **åŠŸèƒ½**                                                                                            |
+============+=====================================================================================================+
| Can        | CANé©±åŠ¨é…ç½®ã€‚                                                                                       |
+------------+-----------------------------------------------------------------------------------------------------+
| CanIf      | CanIfæ¨¡å—ä¸»è¦å¤„ç†ä¸Šå±‚æ¨¡å—ä¸åº•å±‚é©±åŠ¨çš„ä¹‹é—´PDUçš„ä¼ é€’ï¼Œä¸ºä¸Šå±‚æ¨¡å—æä¾›ç»Ÿä¸€çš„æ¥å£æ¥ç®¡ç†ä¸åŒçš„CANç¡¬ä»¶æ¨¡å— |
+------------+-----------------------------------------------------------------------------------------------------+
| EcuC       | ç”¨äºè¾…åŠ©é…ç½®å·¥å…·å®Œæˆé…ç½®çš„æ¨¡å—ã€‚ä¸»è¦æä¾›Pduçš„å®šä¹‰ï¼Œå…¶å®ƒæ¨¡å—é€šè¿‡å…³è”EcuCä¸­Pduï¼Œç›¸äº’å…³è”èµ·æ¥ã€‚        |
+------------+-----------------------------------------------------------------------------------------------------+
| CanTSyn    | CANæ—¶é—´åŒæ­¥æ¨¡å—                                                                                     |
+------------+-----------------------------------------------------------------------------------------------------+
| StbM       | åŒæ­¥æ—¶åŸºç®¡ç†å™¨                                                                                      |
+------------+-----------------------------------------------------------------------------------------------------+

è¡¨ CanTSynåè®®æ ˆé›†æˆçš„æ­¥éª¤

+----------+----------------------------------------+------------------------------------------------------+
| **æ­¥éª¤** | **æ“ä½œ**                               | **è¯´æ˜**                                             |
+==========+========================================+======================================================+
| 1        | ORIENTAIS                              | è‹¥é…ç½®å·¥å…·å·²ç»æ­å»ºï¼Œåˆ™ä»…éœ€è¿›è¡Œåè®®æ ˆæ¨¡å—çš„åŠ è½½æ“ä½œã€‚ |
|          | Stuidoé…ç½®å·¥å…·å·¥ç¨‹æ­å»ºå’Œåè®®æ ˆæ¨¡å—åŠ è½½ |                                                      |
+----------+----------------------------------------+------------------------------------------------------+
| 2        | æ¨¡å—é…ç½®åŠé…ç½®æ–‡ä»¶ç”Ÿæˆ                 | NA                                                   |
+----------+----------------------------------------+------------------------------------------------------+
| 3        | ä»£ç é›†æˆ                               | ç°æœ‰å·¥ç¨‹ã€åè®®æ ˆæºä»£ç å’Œé…ç½®ç”Ÿæˆæ–‡ä»¶çš„é›†æˆã€‚         |
+----------+----------------------------------------+------------------------------------------------------+
| 4        | éªŒè¯æµ‹è¯•                               | NA                                                   |
+----------+----------------------------------------+------------------------------------------------------+

.. note::
   **åè®®æ ˆé›†æˆä¹‹å‰ï¼Œç”¨æˆ·é¡»ç¡®ä¿å·²ç»æœ‰åŸºç¡€å·¥ç¨‹ï¼Œä¸”æœ¬åè®®æ ˆç›¸å…³çš„å…¶ä»–åè®®æ ˆèƒ½æ­£å¸¸å·¥ä½œã€‚**

æ–°å»ºORIENTAIS Studioé…ç½®å·¥ç¨‹åŠæ¨¡å—åŠ è½½
--------------------------------------

#. å®‰è£…ORIENTAIS Studioè½¯ä»¶åï¼ŒåŒå‡»è½¯ä»¶å›¾æ ‡æ‰“å¼€è½¯ä»¶ã€‚

   |image1|

   å›¾ æ–°å»ºå·¥ç¨‹-1

#. èœå•æ FileğŸ¡ªNewğŸ¡ªProjectï¼Œæ–°å»ºå·¥ç¨‹ã€‚

   |image2|

   å›¾ æ–°å»ºå·¥ç¨‹-2

#. åœ¨å¼¹å‡ºçš„æ–°å»ºçª—å£ä¸­é€‰æ‹©Autosarä¸‹çš„ [BSW Project]ï¼Œé€‰æ‹©Nextã€‚

   |image3|

   å›¾ æ–°å»ºå·¥ç¨‹-3

#. åœ¨å¼¹å‡ºçš„çª—å£ä¸­è¾“å…¥å·¥ç¨‹åï¼Œé€‰æ‹©Finishã€‚

   |image4|

   å›¾ æ–°å»ºå·¥ç¨‹-4

#. åœ¨å¼¹å‡ºçš„çª—å£ä¸­é€‰æ‹©Yesã€‚

   |image5|

   å›¾ æ–°å»ºå·¥ç¨‹-5

#. é€‰æ‹©[Bsw_Builder]ï¼Œå³é”®å•å‡»ï¼Œé€‰æ‹©New ECU Configurationã€‚

   |image6|

   å›¾ æ–°å»ºå·¥ç¨‹-6

#. åœ¨å¼¹å‡ºçš„çª—å£ä¸­è¾“å…¥ECUåï¼Œç„¶åé€‰æ‹©Nextã€‚

   |image7|

   å›¾ æ–°å»ºå·¥ç¨‹-7

#. åœ¨å¼¹å‡ºçš„çª—å£ä¸­å‹¾é€‰éœ€æ·»åŠ çš„æ¨¡å—ï¼Œç‚¹å‡»Finishã€‚

   |image8|

   å›¾ æ–°å»ºå·¥ç¨‹-8

#. æ–°å»ºå·¥ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼Œä¸Šä¸€æ­¥æ·»åŠ çš„æ¨¡å—å·²ç»è¢«åŠ å…¥åˆ°å·¥ç¨‹ä¸­ã€‚

   |image9|

   å›¾ æ–°å»ºå·¥ç¨‹-9

æ¨¡å—é…ç½®åŠä»£ç ç”Ÿæˆ
------------------

æ¨¡å—é…ç½®
~~~~~~~~

æ¨¡å—çš„å…·ä½“é…ç½®ï¼Œå–å†³äºå…·ä½“çš„é¡¹ç›®éœ€æ±‚ã€‚è¯¥åè®®æ ˆå„æ¨¡å—é…ç½®é¡¹çš„è¯¦ç»†ä»‹ç»ã€‚

è¡¨ åè®®æ ˆå„æ¨¡å—é…ç½®å‚è€ƒæ–‡æ¡£

+----------+----------------------------------------+-------------------+
| **æ¨¡å—** | **å‚è€ƒæ–‡æ¡£**                           | **è¯´æ˜**          |
+==========+========================================+===================+
| Can      | MCALå¯¹åº”çš„Cané…ç½®æ‰‹å†Œ                  |                   |
+----------+----------------------------------------+-------------------+
| Gpt      | MCALå¯¹åº”çš„Gpté…ç½®æ‰‹å†Œ                  |                   |
+----------+----------------------------------------+-------------------+
| CanIf    | é›†æˆæ‰‹å†Œ_Cané€šä¿¡.pdf                   |                   |
+----------+----------------------------------------+-------------------+
| EcuC     | é›†æˆæ‰‹å†Œ_Cané€šä¿¡.pdf                   |                   |
+----------+----------------------------------------+-------------------+
| CanTSyn  | å‚è€ƒæ‰‹å†Œ_CanTSyn.pdf                   |                   |
+----------+----------------------------------------+-------------------+
| StbM     | å‚è€ƒæ‰‹å†Œ_StbM.pdf                      |                   |
+----------+----------------------------------------+-------------------+

é…ç½®ä»£ç ç”Ÿæˆ
~~~~~~~~~~~~

#. åœ¨ORIENTAIS Studioä¸»ç•Œé¢å·¦æ–¹ï¼Œé€‰æ‹©å¯¹åº”çš„åè®®æ ˆï¼Œå•å‡»å³é”®å¼¹å‡ºValidate
   Allå’ŒGenerateAllèœå•ã€‚

   |image10|

   å›¾ é…ç½®ä»£ç çš„ç”Ÿæˆ-1

#. é€‰æ‹©Validate
   Allå¯¹æœ¬åè®®æ ˆå„é…ç½®é€‰é¡¹è¿›è¡Œæ ¡éªŒï¼Œæ²¡æœ‰é”™è¯¯æç¤ºä¿¡æ¯å³æ ¡éªŒé€šè¿‡ã€‚è‹¥æœ‰é”™è¯¯ä¿¡æ¯ï¼Œè¯·æŒ‰ç…§é”™è¯¯æç¤ºä¿®æ”¹ã€‚

#. é€‰æ‹©Generate
   Allï¼Œç”Ÿæˆé…ç½®æ–‡ä»¶ã€‚å³ä¸‹è§’çš„Consoleçª—å£è¾“å‡ºç”Ÿæˆçš„é…ç½®æ–‡ä»¶ä¿¡æ¯ã€‚

   |image11|

   å›¾ é…ç½®ä»£ç çš„ç”Ÿæˆ-2

#. åœ¨å·¥ç¨‹configæ–‡ä»¶å¤¹ï¼Œå¯æŸ¥çœ‹ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ã€‚

   |image12|

   å›¾ é…ç½®ä»£ç çš„ç”Ÿæˆ-3

åŠŸèƒ½é›†æˆ
--------

ä»£ç é›†æˆ
~~~~~~~~

åè®®æ ˆä»£ç åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šé¡¹ç›®æä¾›çš„åè®®æ ˆæºç å’ŒORIENTAIS
Studioé…ç½®ç”Ÿæˆä»£ç ã€‚

ç”¨æˆ·é¡»å°†åè®®æ ˆæºç å’Œç« èŠ‚ï¼ˆé…ç½®ä»£ç ç”Ÿæˆï¼‰ç”Ÿæˆçš„æºä»£ç æ·»åŠ åˆ°é›†æˆå¼€å‘å·¥å…·çš„å¯¹åº”æ–‡ä»¶å¤¹ã€‚åè®®æ ˆé›†æˆçš„æ–‡ä»¶ç»“æ„ï¼Œè§ç« èŠ‚ï¼ˆæºä»£ç é›†æˆï¼‰ã€‚

.. note::
   **åè®®æ ˆé›†æˆä¹‹å‰ï¼Œç”¨æˆ·é¡»ç¡®ä¿å·²ç»æœ‰åŸºç¡€å·¥ç¨‹ï¼Œä¸”æœ¬åè®®æ ˆç›¸å…³çš„å…¶ä»–åè®®æ ˆèƒ½æ­£å¸¸å·¥ä½œã€‚**

é›†æˆæ³¨æ„äº‹é¡¹
~~~~~~~~~~~~

å¯¹äºé›†æˆè¿‡ç¨‹ä¸­ï¼Œåè®®æ ˆç‰¹æ®Šè¦æ±‚å’Œç”¨æˆ·ç»å¸¸å‡ºç°çš„é—®é¢˜ï¼Œå½’ç±»æ€»ç»“å½¢æˆ è¡¨
åè®®æ ˆé›†æˆçº¦æŸæ¸…å•ã€‚ç”¨æˆ·éœ€é€ä¸€æ’æŸ¥è¡¨ä¸­çš„çº¦æŸé¡¹ï¼Œä»¥é¿å…é›†æˆé—®é¢˜å‡ºç°ã€‚

è¡¨ CanTSynåè®®æ ˆé›†æˆçº¦æŸæ¸…å•

+----------+----------+-----------------------------------------------------------------------------------+
| **ç¼–å·** | **ç±»åˆ«** | **çº¦æŸé™åˆ¶**                                                                      |
+==========+==========+===================================================================================+
| **1**    | å¤´æ–‡ä»¶   | - æ·»åŠ åè®®æ ˆä»£ç ä¹‹åï¼Œç”¨æˆ·éœ€æ›´æ–°é›†æˆå¼€å‘å·¥å…·ä¸­çš„å¤´æ–‡ä»¶è·¯å¾„ã€‚                      |
|          |          |                                                                                   |
|          |          | - è°ƒç”¨åè®®æ ˆAPIçš„æºæ–‡ä»¶ï¼Œéœ€è¦åŒ…å«åè®®æ ˆçš„å¤´æ–‡ä»¶ã€‚                                 |
+----------+----------+-----------------------------------------------------------------------------------+
| **2**    | åˆå§‹åŒ–   | CanTSyn_Initå’ŒStbM_Initåˆå§‹åŒ–å‰éœ€è¦ç¡®ä¿Canå’ŒGptå·²ç»åˆå§‹åŒ–                         |
+----------+----------+-----------------------------------------------------------------------------------+
| **3**    | å‘¨æœŸå‡½æ•° | CanTSyn_MainFunctionå’ŒStbM_MainFunctionæŒ‰ç…§éœ€æ±‚æ”¾ç½®åˆ°ç›¸åº”çš„å‘¨æœŸä»»åŠ¡ä¸­ï¼Œä¸€èˆ¬ä¸º10ms |
+----------+----------+-----------------------------------------------------------------------------------+

é›†æˆç¤ºä¾‹
========

æœ¬ç« èŠ‚é€šè¿‡CanTSynåè®®æ ˆä¸ºä¾‹ï¼Œå‘ç”¨æˆ·å±•ç¤ºCanTSynåè®®æ ˆçš„é›†æˆè¿‡ç¨‹ã€‚ç”¨æˆ·å¯ä»¥æ®æ­¤ç†Ÿæ‚‰CanTSynåè®®æ ˆé…ç½®å·¥å…·çš„é…ç½®è¿‡ç¨‹ï¼Œä»¥åŠå¦‚ä½•åº”ç”¨é…ç½®å·¥å…·ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ã€‚

ä¸ºè®©ç”¨æˆ·æ›´æ¸…æ™°çš„äº†è§£å·¥å…·çš„ä½¿ç”¨ï¼Œæ‰€ç”¨çš„é…ç½®å‡é€ä¸€æ‰‹åŠ¨å®Œæˆã€‚å…³äºCané©±åŠ¨çš„é…ç½®ï¼Œè¯·å‚è€ƒCané…ç½®æ‰‹å†Œã€‚å…³äºGpté©±åŠ¨çš„é…ç½®ï¼Œè¯·å‚è€ƒGpté…ç½®æ‰‹å†Œã€‚CanIfé…ç½®çš„å…·ä½“æ“ä½œè¯·å‚ç…§ã€Šé›†æˆæ‰‹å†Œ_Cané€šä¿¡.pdfã€‹ã€‚

.. note::
   **æœ¬ç¤ºä¾‹ä¸ä»£è¡¨ç”¨æˆ·çš„å®é™…é…ç½®æƒ…å†µï¼Œç”¨æˆ·éœ€è¦æ ¹æ®è‡ªå·±çš„å®é™…éœ€æ±‚ï¼Œå†³å®šå„ä¸ªå‚æ•°çš„é…ç½®ã€‚**

é›†æˆç›®æ ‡
--------

é€šè¿‡Canoeæ¨¡æ‹ŸCanTSynä¸»èŠ‚ç‚¹ï¼Œå‘æœ¬ç¤ºä¾‹çš„ä»èŠ‚ç‚¹å‘é€æ—¶é—´åŒæ­¥æŠ¥æ–‡ï¼Œä»èŠ‚ç‚¹è·å–ä¸»èŠ‚ç‚¹åŒæ­¥çš„æ—¶é—´ã€‚ç”±äºæ—¶é—´åŒæ­¥çš„ä»èŠ‚ç‚¹ä¸å‘å¤–å‘é€æ—¶é—´ï¼Œæ•…é€šè¿‡ä¸€å¸§CAN
IDä¸º0x666çš„CANæŠ¥æ–‡å°†åŒæ­¥åçš„æ—¶é—´è½¬å‘å‡ºæ¥ã€‚

æ¨¡å—çš„é…ç½®
----------

æ–°å»ºé…ç½®å·¥ç¨‹åŠæ¨¡å—åŠ è½½æ“ä½œï¼Œè¯·å‚è€ƒæœ¬æ–‡æ¡£ç« èŠ‚ï¼ˆæ¨¡å—é…ç½®åŠä»£ç ç”Ÿæˆï¼‰ã€‚æ­¤æ¬¡ä»…è¯´æ˜å¦‚ä½•é…ç½®ï¼Œæ¨¡å—çš„é…ç½®é¡¹å…·ä½“ç¤ºæ„å‚è§ã€Šé›†æˆæ‰‹å†Œ_CanTSyn.pdfã€‹å’Œã€Šé›†æˆæ‰‹å†Œ_StbM.pdfã€‹ã€‚

CanTSynæ¨¡å—é…ç½®
~~~~~~~~~~~~~~~

#. åŒå‡»CanTSynæ¨¡å—ï¼Œæ‰“å¼€CanTSynæ¨¡å—çš„é…ç½®ç•Œé¢ã€‚

   |image13|

   å›¾ CanTSynGeneralé…ç½®ç•Œé¢

#. åœ¨CanTSynGeneralä¸‹ï¼Œæœ‰CanTSynDevErrorDetectã€CanTSynMainFunctionPeriodå’ŒCanTSynVersionInfoApi
   ã€CanTSynR19CbkVersionã€CanTSynMultiplePartitionEnabledäº”ä¸ªé…ç½®é¡¹ã€‚

#. å°†CanTSynMainFunctionPeriodé…ç½®ä¸º0.01ï¼Œå…¶ä»–é…ç½®é¡¹ä¿æŒé»˜è®¤ã€‚

   |image14|

   å›¾ CanTSynGlobalTimeDomainé…ç½®ç•Œé¢

#. CanTSynGlobalTimeDomainé…ç½®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

   |image15|

   å›¾ CanTSynGlobalTimeDomainé…ç½®

#. CanTSynGlobalTimeDomain->CanTSynGlobalTimeFupDataIDList->CanTSynGlobalTimeFupDataIDListElementsä¸­çš„é…ç½®(ä½¿ç”¨CRCæ—¶)ï¼Œæ ¹æ®å®¢æˆ·éœ€æ±‚å»å¡«å†™CRCå€¼ã€‚

   |image16|

   å›¾ SynGlobalTimeFupDataIDListElementsçš„é…ç½®

#. CanTSynGlobalTimeSlaves->CanTSynGlobalTimeSlaveçš„é…ç½®ï¼ˆåšä»èŠ‚ ç‚¹ï¼‰ï¼š

   |image17|

   å›¾ CanTSynGlobalTimeSlaveçš„é…ç½®

#. CanTSynGlobalTimeSlaves->CanTSynGlobalTimeSlavePdus->CanTSynGlobalTimeSlavePduçš„é…ç½®ï¼š

   |image18|

   å›¾ CanTSynGlobalTimeSlavePduçš„é…ç½®

#. CanTSynGlobalTimeSyncDataIDLists->CanTSynGlobalTimeSyncDataIDL
   ist->CanTSynGlobalTimeSyncDataIDListElementsçš„é…ç½®(ä½¿ç”¨CRCæ—¶)æ ¹
   æ®å®¢æˆ·éœ€æ±‚å»å¡«å†™CRCå€¼ã€‚

   |image19|

   å›¾ CanTSynGlobalTimeSyncDataIDListElementsçš„é…ç½®

#. CanTSynGlobalTimeMasters->CanTSynGlobalTimeMasterçš„é…ç½®ï¼ˆåšä¸»èŠ‚
   ç‚¹ï¼‰ï¼š

   CanTSynCyclicMsgResumeTimeï¼šåœ¨å³æ—¶ä¼ è¾“ä¹‹å‰ï¼Œç¬¬ä¸€ä¸ªå¸¸è§„å‘¨æœŸæ—¶é—´çš„æ¶ˆæ¯ä¼ è¾“å‘ç”Ÿçš„æ—¶é—´ã€‚

   CanTSynGlobalTimeDebounceTimeï¼šSYNCæŠ¥æ–‡å’ŒFUPæŠ¥æ–‡ä¹‹é—´çš„é—´éš”æ—¶é—´ã€‚

   CanTSynGlobalTimeTxCrcSecuredï¼šé€‰æ‹©æ˜¯å¦æ”¯æŒCRCã€‚

   CanTSynGlobalTimeTxPeriodï¼šåŒæ­¥æŠ¥æ–‡å‘¨æœŸã€‚

   CanTSynImmediateTimeSyncï¼šå¯ç”¨/ç¦ç”¨åœ¨CanTSyn_MainFunction()ä¸­å¯¹StbM_GetTimeBaseUpdateCounter()çš„å‘¨æœŸè½®è¯¢ã€‚

   CanTSynMasterConfirmationTimeoutï¼šè¿™è¡¨ç¤ºæ¯æ¬¡ä¼ è¾“Timesyncæ¶ˆæ¯åçš„ç¡®è®¤è¶…æ—¶æ—¶é—´ã€‚

   |image20|

   å›¾ CanTSynGlobalTimeMasterçš„é…ç½®

#. CanTSynGlobalTimeMaster->CanTSynGlobalTimeMasterPdus->CanTSynGloa
   lTimeMasterPduçš„é…ç½®ï¼š

   |image21|

   å›¾ CanTSynGlobalTimeMasterPduçš„é…ç½®

StbMæ¨¡å—çš„é…ç½®
~~~~~~~~~~~~~~

#. åŒå‡»StbMæ¨¡å—ï¼Œæ‰“å¼€StbMæ¨¡å—çš„é…ç½®ç•Œé¢ã€‚

   |image22|

   å›¾ StbMGeneralçš„é…ç½®ç•Œé¢

#. åœ¨StbMGeneralçš„é…ç½®ã€‚è‹¥ä½¿ç”¨GPTæ—¶é’Ÿï¼Œéœ€æ‰“å¼€StbMGptTimerRefï¼Œå¹¶
   é€‰æ‹©mcalé…ç½®çš„Gptæ—¶é’Ÿï¼›è‹¥ç”¨Ethç¡¬ä»¶æ—¶é’Ÿï¼Œåˆ™ä¸å‹¾é€‰ã€‚

   |image23|

   å›¾ StbMGeneralçš„é…ç½®

#. StbMSynchronizedTimeBases->StbMSynchronizedTimeBaseçš„é…ç½®ã€‚

   |image24|

   å›¾ StbMSynchronizedTimeBaseé…ç½®ç•Œé¢

#. StbMSynchronizedTimeBases->StbMSynchronizedTimeBase->StbMLocal
   TimeClocks->StbMLocalTimeClockçš„é…ç½®ï¼š

#. StbMClockFrequencyä¸­å¡«å†™StbMæ‰€å¼•ç”¨çš„Gptå®šæ—¶å™¨çš„æ—¶é’Ÿé¢‘ç‡ã€‚è‹¥æ˜¯
   Ethæ—¶é’Ÿåˆ™é»˜è®¤1000000000ã€‚

#. StbMLocalTimeHardwareå¼•ç”¨æ‰€éœ€è¦å¼•ç”¨çš„Gptçš„å®šæ—¶å™¨é€šé“ã€‚è‹¥æ˜¯Eth
   æ—¶é’Ÿåˆ™é»˜è®¤1ã€‚

   |image25|

   å›¾ StbMLocalTimeClocké…ç½®ç•Œé¢

#. StbMSynchronizedTimeBases->StbMSynchronizedTimeBase->StbMLocal
   TimeClocks->StbMTimeCorrectionçš„é…ç½®ï¼š

   StbMAllowMasterRateCorrectionå¦‚æœä¸»èŠ‚ç‚¹å¯ç”¨correctionåŠŸèƒ½åˆ™éœ€è¦å¼€å¯ã€‚

   StbMMasterRateDeviationMaxå¡«å†™ç”±
   StbM_SetRateCorrectionè®¾ç½®çš„é€Ÿç‡åå·®å€¼çš„æœ€å¤§å…è®¸ç»å¯¹å€¼ã€‚

   StbMOffsetCorrectionAdaptionIntervalå¡«å†™é€‚åº”æ€§çš„é€Ÿç‡çŸ«æ­£è¶³ä»¥æ¶ˆé™¤é€Ÿç‡å’Œæ—¶é—´åå·®å€¼çš„æ—¶é—´åŒºé—´ã€‚

   StbMOffsetCorrectionJumpThresholdç”¨äºå†³å®šä½¿ç”¨ä»€ä¹ˆæ ·çš„çŸ«æ­£æ–¹å¼ã€‚åå·®å€¼è‹¥å°äºæ­¤å€¼ï¼Œåˆ™åœ¨å®šä¹‰çš„æ—¶é—´å‘¨æœŸå†…ä½¿ç”¨çº¿æ€§ç¼©å‡ï¼ˆlinear
   reductionï¼‰çŸ«æ­£ã€‚è‹¥å¤§äºæ­¤å€¼ï¼Œåˆ™ä»¥è·³è·ƒçš„æ–¹å¼ç«‹å³è®¾ç½®æ­£ç¡®çš„æ—¶é—´å’Œé€Ÿç‡ã€‚

   StbMRateCorrectionMeasurementDurationå¡«å†™ç”¨äºè®¡ç®—é€Ÿç‡å·®çš„æ—¶é—´åŒºé—´ã€‚

#. StbMRateCorrectionsPerMeasurementDurationå¡«å†™åŒæ—¶è¿›è¡Œé€Ÿç‡æµ‹é‡çš„
   æ¬¡æ•°ï¼Œä»¥ç¡®å®šå½“å‰é€Ÿç‡åå·®ã€‚

   |image26|

   å›¾ StbMLocalTimeCorrectioné…ç½®ç•Œé¢

æºä»£ç é›†æˆ
----------

é¡¹ç›®äº¤ä»˜ç»™ç”¨æˆ·çš„å·¥ç¨‹ç»“æ„å¦‚ä¸‹ï¼š

|image27|

å›¾ å·¥ç¨‹ç»“æ„ç›®å½•

- BSWç›®å½•ï¼Œå­˜æ”¾æ¨¡å—ç›¸å…³çš„æºä»£ç å’Œé…ç½®ä»£ç ã€‚å¯ä»¥çœ‹åˆ°Sourceç›®å½•ä¸‹å„ä¸ªæ–‡ä»¶å¤¹ä¸‹æ˜¯å„ä¸ªæ¨¡å—çš„æºä»£ç ã€‚

- BSWä¸‹çš„Config->BSW_Configç›®å½•ï¼Œç”¨äºå­˜æ”¾é…ç½®å·¥å…·ç”Ÿæˆçš„é…ç½®æ–‡ä»¶

CanTSynåè®®æ ˆæºä»£ç é›†æˆæ­¥éª¤å¦‚ä¸‹ï¼š

#. å°†MCALç”Ÿæˆçš„CANã€GPTæ¨¡å—é…ç½®æ–‡ä»¶å’ŒORIENTAIS
   Studioç”Ÿæˆçš„é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°å¯¹åº”çš„æ–‡ä»¶å¤¹ä¸­ï¼›

#. å°†MCALæä¾›çš„CANæ¨¡å—æºç å’Œæ™®åæä¾›çš„åè®®æ ˆæºä»£ç æ–‡ä»¶å¤åˆ¶åˆ°å¯¹åº”çš„æ–‡ä»¶å¤¹ä¸­ã€‚

#. æ·»åŠ æ–°å¢åŠ çš„æ¨¡å—çš„ä»£ç å¤´æ–‡ä»¶è·¯å¾„åˆ°å·¥ç¨‹è®¾ç½®ä¸­

åè®®æ ˆè°ƒåº¦é›†æˆ
--------------

CanTSynåè®®æ ˆè°ƒåº¦é›†æˆæ­¥éª¤å¦‚ä¸‹ï¼š

#. åè®®æ ˆè°ƒåº¦é›†æˆï¼Œéœ€è¦é€ä¸€æ’æŸ¥å¹¶å®ç°è¡¨ åè®®æ ˆé›†æˆçº¦æŸæ¸…å•
   æ‰€ç½—åˆ—çš„é—®é¢˜ï¼Œä»¥é¿å…é›†æˆå‡ºç°å·®é”™ã€‚

#. ç¼–è¯‘é“¾æ¥ä»£ç ï¼Œå°†ç”Ÿæˆçš„elfæ–‡ä»¶çƒ§å†™è¿›èŠ¯ç‰‡ã€‚

CanTSynåè®®æ ˆæœ‰å…³çš„ä»£ç ï¼Œåœ¨ä¸‹æ–¹çš„main.cæ–‡ä»¶ä¸­ç»™å‡ºé‡ç‚¹æ ‡æ³¨ã€‚

.. note::
   **æœ¬ç¤ºä¾‹ä¸­ï¼ŒCanTSynåè®®æ ˆåˆå§‹åŒ–çš„ä»£ç å’Œå¯åŠ¨é€šä¿¡çš„ä»£ç ç½®äºmain.cæ–‡ä»¶ï¼Œå¹¶ä¸ä»£è¡¨å…¶ä»–é¡¹ç›®åŒæ ·é€‚ç”¨äºå°†å…¶ç½®äºmain.cæ–‡ä»¶ä¸­ã€‚**

.. code-block:: c
   :linenos:
   :emphasize-lines: 6-10, 26-29, 32, 38-39, 42-45, 57-58, 61-71

   #include <machine/wdtcon.h>
   #include "Mcu.h"
   #include "Port.h"

   // CanTSynåè®®æ ˆç›¸å…³æ¨¡å—å¤´æ–‡ä»¶
   #include "Can_17_MCanP.h"
   #include "CanIf.h"
   #include "Gpt.h"
   #include "StbM.h"
   #include "CanTSyn.h"

   StbM_TimeStampType timestamp;
   StbM_UserDataType userData;
   Uint8 Data[8] = {0};
   Can_PduType PduInfo = {0,8,0x666,&Data[0]};

   int main(void)
   {
       /*Initialize ECUM Module*/
       EcuM_Init(&EcuM_ConfigAlternative[0]);

       /*Initialize FlsLoader*/
       FlsLoader_Init(NULL_PTR);

       // åˆå§‹åŒ–Canã€CanIfã€CanTSynã€StbMæ¨¡å—
       StbM_Init(&StbM_Config);  
       Can_17_MCanP_Init(&Can_17_MCanP_ConfigRoot[0]);
       CanIf_Init(&CanIf_InitCfgSet);
       CanTSyn_Init(&CanTSyn_config);   

       // æ‰“å¼€é€šä¿¡ï¼ˆä¸»èŠ‚ç‚¹ä½¿ç”¨ï¼‰
       CanIf_SetControllerMode(0, CANIF_CS_STARTED);

       Gpt_EnableNotification(GptConf_GptChannel_Gpt_1ms);
       Gpt_StartTimer(GptConf_GptChannel_Gpt_1ms, 100000);
       Gpt_StartTimer(GptChannelConfiguration_STBM, 0xFFFFFFu);

       StbM_TimeStampType test1 = {0u};
       StbM_UserDataType  test2 = {0u};

       // ä¸»èŠ‚ç‚¹éœ€è¦æ·»åŠ åˆå§‹åŒ–æˆæ—¶
       test1.secondsHi = 0;
       test1.seconds = 1696903810;  // åˆå§‹æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
       test1.nanoseconds = 0;       // åˆå§‹æ—¶é—´æˆ³ï¼ˆçº³ç§’ï¼‰
       StbM_SetGlobalTime(0,&test1,&test2);

       /* infinite loop */
       while (1)
       {
           if(Gpt_1msFlag == TRUE)
           {
               Gpt_1msFlag = FALSE;
           }
           if(Gpt_10msFlag == TRUE)
           {
               // CanTSynã€StbMæ¨¡å—å‘¨æœŸå¤„ç†å‡½æ•°
               CanTSyn_MainFunction();
               StbM_MainFunction();

               // åšä»èŠ‚ç‚¹æ—¶çš„æµ‹è¯•ä»£ç ï¼šStbM_GetCurrentTimeè·å–æ—¶é—´ï¼Œå°†åŒæ­¥åˆ°çš„æ—¶é—´é€šè¿‡0x666æŠ¥æ–‡è½¬å‘å‡ºæ¥
               StbM_GetCurrentTime(0, &timestamp,&userData);
               PduInfo.sdu[0] = (uint8)((StbM_TimeStamp.seconds & 0xff000000) >> 24);
               PduInfo.sdu[1] = (uint8)((StbM_TimeStamp.seconds & 0x00ff0000) >> 16);
               PduInfo.sdu[2] = (uint8)((StbM_TimeStamp.seconds & 0x0000ff00) >> 8);
               PduInfo.sdu[3] = (uint8)((StbM_TimeStamp.seconds & 0x000000ff));
               PduInfo.sdu[4] = (uint8)((StbM_TimeStamp.nanoseconds & 0xff000000) >> 24);
               PduInfo.sdu[5] = (uint8)((StbM_TimeStamp.nanoseconds & 0x00ff0000) >> 16);
               PduInfo.sdu[6] = (uint8)((StbM_TimeStamp.nanoseconds & 0x0000ff00) >> 8);
               PduInfo.sdu[7] = (uint8)((StbM_TimeStamp.nanoseconds & 0x000000ff));

               Can_Write(2, &PduInfo);
           }
       }
       return 1;
   }

éªŒè¯ç»“æœ
--------

æ ¹æ®é›†æˆç›®æ ‡ï¼Œèƒ½å¤Ÿè·ŸCanoeæ­£å¸¸é€šä¿¡ï¼Œä»¥ä¸‹æ˜¯æ—¶é—´åŒæ­¥çš„åŒæ­¥log.

|image28|

å›¾ éªŒè¯ç»“æœ

.. |image1| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image2.png
   :width: 5.76736in
   :height: 3.11736in
.. |image2| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image3.png
   :width: 5.76736in
   :height: 3.11389in
.. |image3| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image4.png
   :width: 4.26818in
   :height: 4.11783in
.. |image4| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image5.png
   :width: 4.4128in
   :height: 3.66201in
.. |image5| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image6.png
   :width: 5.39516in
   :height: 2.53093in
.. |image6| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image7.png
   :width: 4.29931in
   :height: 1.97778in
.. |image7| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image8.png
   :width: 3.5041in
   :height: 3.37381in
.. |image8| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image9.png
   :width: 3.11763in
   :height: 4.16701in
.. |image9| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image10.png
   :width: 2.77741in
   :height: 3.28101in
.. |image10| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image11.png
   :width: 3.77191in
   :height: 1.80023in
.. |image11| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image12.png
   :width: 3.05251in
   :height: 1.37519in
.. |image12| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image13.png
   :width: 3.43559in
   :height: 3.71643in
.. |image13| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image14.png
   :width: 5.61077in
   :height: 2.80234in
.. |image14| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image15.png
   :width: 5.76736in
   :height: 3.77292in
.. |image15| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image16.png
   :width: 5.76736in
   :height: 1.55903in
.. |image16| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image17.png
   :width: 5.76736in
   :height: 2.85417in
.. |image17| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image18.png
   :width: 5.76736in
   :height: 1.54514in
.. |image18| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image19.png
   :width: 5.43502in
   :height: 0.94792in
.. |image19| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image20.png
   :width: 5.76736in
   :height: 2.94444in
.. |image20| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image21.png
   :width: 5.76736in
   :height: 2.12917in
.. |image21| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image22.png
   :width: 4.864in
   :height: 0.84807in
.. |image22| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image23.png
   :width: 5.76736in
   :height: 3.31736in
.. |image23| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image24.png
   :width: 3.48319in
   :height: 2.13689in
.. |image24| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image25.png
   :width: 5.76736in
   :height: 3.03472in
.. |image25| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image26.png
   :width: 5.76736in
   :height: 1.33819in
.. |image26| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image27.png
   :width: 5.12411in
   :height: 2.40737in
.. |image27| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image28.png
   :width: 3.17708in
   :height: 3.13542in
.. |image28| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_CANTSyn/image29.png
   :width: 5.76736in
   :height: 3.94583in
