====================
EthTSyn
====================

ç›®æ ‡
====

æœ¬é›†æˆæ‰‹å†Œç”¨äºæŒ‡å¯¼å®¢æˆ·è¿›è¡Œä»¥å¤ªç½‘æ—¶é—´åŒæ­¥é›†æˆï¼Œæ–‡æ¡£ä¸»è¦åŒ…æ‹¬çš„å†…å®¹ä¸ºï¼šåè®®æ ˆé›†æˆæŒ‡å¯¼ã€åŸºäºæ™®é€šåº”ç”¨çš„é›†æˆç¤ºä¾‹è®²è§£ã€é¡¹ç›®é›†æˆç‰¹æ®Šè¯´æ˜ã€‚

ç”±äºå„é¡¹ç›®çš„éœ€æ±‚ä¸åŒï¼Œé›†æˆç¤ºä¾‹ä¸ä¼šé’ˆå¯¹äºç‰¹å®šçš„å•†ä¸šé¡¹ç›®åšè¯¦ç»†è®²è§£ã€‚

ç¼©å†™è¯å’Œæœ¯è¯­
============

.. table:: è¡¨ ç¼©å†™è¯å’Œæœ¯è¯­

   +-----------------+------------------------------------------------------+
   | **ç¼©å†™è¯/æœ¯è¯­** | **æè¿°**                                             |
   +=================+======================================================+
   | EthIf           | Eth é€šä¿¡çš„æ¥å£æ¨¡å—                                   |
   +-----------------+------------------------------------------------------+
   | EthTSyn         | TimeSyncOverEthernet åŸºäºä»¥å¤ªç½‘çš„æ—¶é—´åŒæ­¥            |
   +-----------------+------------------------------------------------------+
   | StbM            | SynchronizedTimeBaseManager åŒæ­¥æ—¶é—´åŸºç®¡ç†           |
   +-----------------+------------------------------------------------------+

å‚è€ƒæ–‡æ¡£
========

[1] å‚è€ƒæ‰‹å†Œ_EthTSyn.pdf

[2] å‚è€ƒæ‰‹å†Œ_StbM.pdf

[3] å‚è€ƒæ‰‹å†Œ_EthIf.pdf

åè®®æ ˆé›†æˆ
==========

é¡¹ç›®äº¤ä»˜çš„å†…å®¹ä¸ºï¼šä»¥å¤ªç½‘æ—¶é—´åŒæ­¥åè®®æ ˆæºç å’ŒORIENTAIS
Studioé…ç½®å·¥å…·ã€‚åè®®æ ˆç»†åˆ†ä¸ºåè®®æ ˆçš„å„æ¨¡å—åŠå…¶å¯¹åº”çš„é…ç½®å·¥å…·æ¨¡å—ã€‚

ä»¥å¤ªç½‘æ—¶é—´åŒæ­¥åè®®æ ˆå„é…ç½®æ¨¡å—çš„åŠŸèƒ½ä»‹ç»ã€‚

ä½¿ç”¨åè®®æ ˆæºç å’Œé…ç½®å·¥å…·ï¼Œè¿›è¡Œåè®®æ ˆçš„é›†æˆçš„æ­¥éª¤ã€‚

.. table:: è¡¨ ä»¥å¤ªç½‘æ—¶é—´åŒæ­¥åè®®æ ˆå„é…ç½®æ¨¡å—ä»‹ç»

   +------------+-----------------------------------------------------------------------------------------------------+
   | **æ¨¡å—å** | **åŠŸèƒ½**                                                                                            |
   +============+=====================================================================================================+
   | Eth        | Ethé©±åŠ¨é…ç½®ã€‚                                                                                       |
   +------------+-----------------------------------------------------------------------------------------------------+
   | EthIf      | EthIfæ¨¡å—ä¸»è¦å¤„ç†ä¸Šå±‚æ¨¡å—ä¸åº•å±‚é©±åŠ¨çš„ä¹‹é—´PDUçš„ä¼ é€’ï¼Œä¸ºä¸Šå±‚æ¨¡å—æä¾›ç»Ÿä¸€çš„æ¥å£æ¥ç®¡ç†ä¸åŒçš„Ethç¡¬ä»¶æ¨¡å— |
   +------------+-----------------------------------------------------------------------------------------------------+
   | EthTSyn    | EthTSynæ¨¡å—å¤„ç†ä»¥å¤ªç½‘ä¸Šçš„æ—¶é—´åŒæ­¥åè®®                                                               |
   +------------+-----------------------------------------------------------------------------------------------------+
   | StbM       | åŒæ­¥æ—¶é—´åŸºç¡€ç®¡ç†å™¨çš„ç›®çš„æ˜¯æä¾›åŒæ­¥ç»™å®¢æˆ·çš„æ—¶é—´åŸºæ•°ï¼Œä¸é“¾è·¯ä¸Šçš„å…¶ä»–èŠ‚ç‚¹ä¸Šçš„æ—¶é—´åŸºæ•°åŒæ­¥ã€‚            |
   +------------+-----------------------------------------------------------------------------------------------------+

.. table:: è¡¨ ä»¥å¤ªç½‘æ—¶é—´åŒæ­¥åè®®æ ˆé›†æˆçš„æ­¥éª¤

   +----------+----------------------------------------+------------------------------------------------------+
   | **æ­¥éª¤** | **æ“ä½œ**                               | **è¯´æ˜**                                             |
   +==========+========================================+======================================================+
   | 1        | ORIENTAIS                              | è‹¥é…ç½®å·¥å…·å·²ç»æ­å»ºï¼Œåˆ™ä»…éœ€è¿›è¡Œåè®®æ ˆæ¨¡å—çš„åŠ è½½æ“ä½œã€‚ |
   |          | Stuidoé…ç½®å·¥å…·å·¥ç¨‹æ­å»ºå’Œåè®®æ ˆæ¨¡å—åŠ è½½ |                                                      |
   +----------+----------------------------------------+------------------------------------------------------+
   | 2        | æ¨¡å—é…ç½®åŠé…ç½®æ–‡ä»¶ç”Ÿæˆ                 | NA                                                   |
   +----------+----------------------------------------+------------------------------------------------------+
   | 3        | ä»£ç é›†æˆ                               | ç°æœ‰å·¥ç¨‹ã€åè®®æ ˆæºä»£ç å’Œé…ç½®ç”Ÿæˆæ–‡ä»¶çš„é›†æˆã€‚         |
   +----------+----------------------------------------+------------------------------------------------------+
   | 4        | éªŒè¯æµ‹è¯•                               | NA                                                   |
   +----------+----------------------------------------+------------------------------------------------------+

.. note::
   **åè®®æ ˆé›†æˆä¹‹å‰ï¼Œç”¨æˆ·é¡»ç¡®ä¿å·²ç»æœ‰åŸºç¡€å·¥ç¨‹ï¼Œä¸”æœ¬åè®®æ ˆç›¸å…³çš„å…¶ä»–åè®®æ ˆèƒ½æ­£å¸¸å·¥ä½œã€‚**

æ–°å»ºORIENTAIS Studioé…ç½®å·¥ç¨‹åŠæ¨¡å—åŠ è½½
--------------------------------------

#. å®‰è£…ORIENTAIS Studioè½¯ä»¶åï¼ŒåŒå‡»è½¯ä»¶å›¾æ ‡æ‰“å¼€è½¯ä»¶ã€‚

   |image1|

   å›¾ æ–°å»ºå·¥ç¨‹-1

#. èœå•æ FileğŸ¡ªNewğŸ¡ªProjectï¼Œæ–°å»ºå·¥ç¨‹ã€‚

   |image2|

   å›¾ æ–°å»ºå·¥ç¨‹-2

#. åœ¨å¼¹å‡ºçš„æ–°å»ºçª—å£ä¸­é€‰æ‹©Autosarä¸‹çš„ [BSW Project]ï¼Œé€‰æ‹©Nextã€‚

   |image3|

   å›¾ æ–°å»ºå·¥ç¨‹-3

#. åœ¨å¼¹å‡ºçš„çª—å£ä¸­è¾“å…¥å·¥ç¨‹åï¼Œé€‰æ‹©Finishã€‚

   |image4|

   å›¾ æ–°å»ºå·¥ç¨‹-4

#. åœ¨å¼¹å‡ºçš„çª—å£ä¸­é€‰æ‹©Yesã€‚

   |image5|

   å›¾ æ–°å»ºå·¥ç¨‹-5

#. é€‰æ‹©[Bsw_Builder]ï¼Œå³é”®å•å‡»ï¼Œé€‰æ‹©New ECU Configurationã€‚

   |image6|

   å›¾ æ–°å»ºå·¥ç¨‹-6

#. åœ¨å¼¹å‡ºçš„çª—å£ä¸­è¾“å…¥ECUåï¼Œç„¶åé€‰æ‹©Nextã€‚

   |image7|

   å›¾ æ–°å»ºå·¥ç¨‹-7

#. åœ¨å¼¹å‡ºçš„çª—å£ä¸­å‹¾é€‰éœ€æ·»åŠ çš„æ¨¡å—ï¼Œç‚¹å‡»Finishã€‚

   |image8|

   å›¾ æ–°å»ºå·¥ç¨‹-8

#. æ–°å»ºå·¥ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼Œä¸Šä¸€æ­¥æ·»åŠ çš„æ¨¡å—å·²ç»è¢«åŠ å…¥åˆ°å·¥ç¨‹ä¸­ã€‚

   |image9|

   å›¾ æ–°å»ºå·¥ç¨‹-9

æ¨¡å—é…ç½®åŠä»£ç ç”Ÿæˆ
------------------

æ¨¡å—é…ç½®
~~~~~~~~

æ¨¡å—çš„å…·ä½“é…ç½®ï¼Œå–å†³äºå…·ä½“çš„é¡¹ç›®éœ€æ±‚ã€‚è¯¥åè®®æ ˆå„æ¨¡å—é…ç½®é¡¹çš„è¯¦ç»†ä»‹ç»ï¼Œå‚è§è¡¨ã€‚

.. table:: è¡¨ åè®®æ ˆå„æ¨¡å—é…ç½®å‚è€ƒæ–‡æ¡£

   +----------+----------------------------------------+-------------------+
   | **æ¨¡å—** | **å‚è€ƒæ–‡æ¡£**                           | **è¯´æ˜**          |
   +==========+========================================+===================+
   | Eth      | MCALå¯¹åº”çš„Ethé…ç½®æ‰‹å†Œ                  |                   |
   +----------+----------------------------------------+-------------------+
   | EthIf    | å‚è€ƒæ‰‹å†Œ_EthIf.pdf                     |                   |
   +----------+----------------------------------------+-------------------+

é…ç½®ä»£ç ç”Ÿæˆ
~~~~~~~~~~~~

#. åœ¨ORIENTAIS Stuidoä¸»ç•Œé¢å·¦æ–¹ï¼Œé€‰æ‹©å¯¹åº”çš„åè®®æ ˆï¼Œå•å‡»å³é”®å¼¹å‡ºValidate
   Allå’ŒGenerate Allèœå•ã€‚

   |image10|

   å›¾ é…ç½®ä»£ç çš„ç”Ÿæˆ-1

#. é€‰æ‹©Validate
   Allå¯¹æœ¬åè®®æ ˆå„é…ç½®é€‰é¡¹è¿›è¡Œæ ¡éªŒï¼Œæ²¡æœ‰é”™è¯¯æç¤ºä¿¡æ¯å³æ ¡éªŒé€šè¿‡ã€‚è‹¥æœ‰é”™è¯¯ä¿¡æ¯ï¼Œè¯·æŒ‰ç…§é”™è¯¯æç¤ºä¿®æ”¹ã€‚

#. é€‰æ‹©Generate
   Allï¼Œç”Ÿæˆé…ç½®æ–‡ä»¶ã€‚å³ä¸‹è§’çš„Consoleçª—å£è¾“å‡ºç”Ÿæˆçš„é…ç½®æ–‡ä»¶ä¿¡æ¯ã€‚

   |image11|

   å›¾ é…ç½®ä»£ç çš„ç”Ÿæˆ-2

#. å°†ORIENTAIS Studioåˆ‡æ¢åˆ°Resourceæ¨¡å¼ï¼Œå³å¯æŸ¥çœ‹ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ã€‚

   |image12|

   å›¾ é…ç½®ä»£ç çš„ç”Ÿæˆ-3

åŠŸèƒ½é›†æˆ
--------

ä»£ç é›†æˆ
~~~~~~~~

åè®®æ ˆä»£ç åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šé¡¹ç›®æä¾›çš„åè®®æ ˆæºç å’ŒORIENTAIS
Studioé…ç½®ç”Ÿæˆä»£ç ã€‚

ç”¨æˆ·é¡»å°†åè®®æ ˆæºç å’Œç« èŠ‚ï¼ˆé…ç½®ä»£ç ç”Ÿæˆï¼‰ç”Ÿæˆçš„æºä»£ç æ·»åŠ åˆ°é›†æˆå¼€å‘å·¥å…·çš„å¯¹åº”æ–‡ä»¶å¤¹ã€‚åè®®æ ˆé›†æˆçš„æ–‡ä»¶ç»“æ„ï¼Œè§ç« èŠ‚ï¼ˆæºç é›†æˆï¼‰ã€‚

.. note::
   **åè®®æ ˆé›†æˆä¹‹å‰ï¼Œç”¨æˆ·é¡»ç¡®ä¿å·²ç»æœ‰åŸºç¡€å·¥ç¨‹ï¼Œä¸”æœ¬åè®®æ ˆç›¸å…³çš„å…¶ä»–åè®®æ ˆèƒ½æ­£å¸¸å·¥ä½œã€‚**

é›†æˆç¤ºä¾‹
========

æœ¬ç« èŠ‚é€šè¿‡ä»¥å¤ªç½‘æ—¶é—´åŒæ­¥åè®®æ ˆä¸ºä¾‹ï¼Œå‘ç”¨æˆ·å±•ç¤ºä»¥å¤ªç½‘æ—¶é—´åŒæ­¥åè®®æ ˆçš„é›†æˆè¿‡ç¨‹ã€‚ç”¨æˆ·å¯ä»¥æ®æ­¤ç†Ÿæ‚‰ä»¥å¤ªç½‘æ—¶é—´åŒæ­¥åè®®æ ˆé…ç½®å·¥å…·çš„é…ç½®è¿‡ç¨‹ï¼Œä»¥åŠå¦‚ä½•åº”ç”¨é…ç½®å·¥å…·ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ã€‚

ä¸ºè®©ç”¨æˆ·æ›´æ¸…æ™°çš„äº†è§£å·¥å…·çš„ä½¿ç”¨ï¼Œæ‰€ç”¨çš„é…ç½®å‡é€ä¸€æ‰‹åŠ¨å®Œæˆï¼ŒEthiféƒ¨åˆ†é…ç½®é›†æˆè¯·å‚è€ƒã€Šå‚è€ƒæ‰‹å†Œ_EthIf.pdfã€‹ã€‚

.. note::
   **æœ¬ç¤ºä¾‹ä¸ä»£è¡¨ç”¨æˆ·çš„å®é™…é…ç½®æƒ…å†µï¼Œç”¨æˆ·éœ€è¦æ ¹æ®è‡ªå·±çš„å®é™…éœ€æ±‚ï¼Œå†³å®šå„ä¸ªå‚æ•°çš„é…ç½®ã€‚**

é›†æˆç›®æ ‡
--------

å®¢æˆ·èƒ½é€šè¿‡ç¬¬ä¸‰æ–¹åŒæ­¥å·¥å…·ï¼ˆCanoeï¼‰å¯¹æ±½è½¦ç”µå­ç”µæ§å•å…ƒè¿›è¡ŒåŒæ­¥åŠŸèƒ½å®ç°ï¼Œä¸ºå…¶æä¾›è¯»å‡ºåŒæ­¥æ•°æ®ã€åŒæ­¥å·®å€¼è¯»å–åŠç›¸å…³é€šä¿¡æœåŠ¡çš„è½¯ä»¶æ¨¡å—ã€‚

æ¨¡å—çš„é…ç½®
----------

æ–°å»ºé…ç½®å·¥ç¨‹åŠæ¨¡å—åŠ è½½æ“ä½œï¼Œè¯·å‚è€ƒæœ¬æ–‡æ¡£ç« èŠ‚ï¼ˆæ¨¡å—é…ç½®åŠä»£ç ç”Ÿæˆï¼‰ã€‚

StbMæ¨¡å—é…ç½®
~~~~~~~~~~~~

#. åŒå‡»StbMæ¨¡å—ï¼Œæ‰“å¼€StbMæ¨¡å—çš„é…ç½®ç•Œé¢ã€‚

   |image13|

   å›¾ StbMGeneralé…ç½®ç•Œé¢

#. åœ¨StbMGeneralä¸‹ï¼Œæ¯ä¸ªé€‰é¡¹å…·ä½“æ³¨é‡Šæ„æ€å¯åœ¨å³ä¸‹è§’æŸ¥æ‰¾ã€‚

#. åœ¨StbMSynchronizedTimeBaseç•Œé¢,å³é”®æ–°å»ºä¸¤ä¸ªæ—¶é—´åŸºï¼Œä¸€ä¸ªä¸ºä¸»ï¼Œä¸€ä¸ªä¸ºä»ä¸¤ç§æ¨¡å¼é…ç½®ä¸€è‡´ï¼Œæ­¤å¤„éœ€è¦æ³¨æ„StbMLocalTimeClockå®¹å™¨ä¸­StbMClockFrequencyä¸ºç¡¬ä»¶å¼•ç”¨GPTçš„ä¸»é¢‘æ—¶é—´ï¼ŒStbMLocalTimeHardwareä¸ºå¼•ç”¨MCALé…ç½®çš„GPTæ¨¡å—ï¼›è‹¥ç”¨Ethç¡¬ä»¶æ—¶é’Ÿï¼Œåˆ™ä¸å‹¾é€‰ã€‚

   å…¶ä»–é…ç½®é¡¹å®¢æˆ·å¯æŒ‰OEMéœ€æ±‚é…ç½®ï¼Œæ­¤å¤„é…ç½®åªæ˜¯ç®€å•Demoé…ç½®ã€‚

   |image14|

   å›¾ StbMSynchronizedTimeBaseé…ç½®ç•Œé¢-1

#. StbMSynchronizedTimeBases->StbMSynchronizedTimeBase->StbMLocalTimeClocks->StbMLocalTimeClockçš„é…ç½®ï¼š

   |image15|

   å›¾ StbMSynchronizedTimeBaseé…ç½®ç•Œé¢-2

   StbMClockFrequencyä¸­å¡«å†™StbMæ‰€å¼•ç”¨çš„Gptå®šæ—¶å™¨çš„æ—¶é’Ÿé¢‘ç‡ã€‚è‹¥æ˜¯Ethæ—¶é’Ÿåˆ™é»˜è®¤1000000000ã€‚

   StbMLocalTimeHardwareå¼•ç”¨æ‰€éœ€è¦å¼•ç”¨çš„Gptçš„å®šæ—¶å™¨é€šé“ã€‚è‹¥æ˜¯Ethæ—¶é’Ÿåˆ™é»˜è®¤1ã€‚

#. StbMSynchronizedTimeBases->StbMSynchronizedTimeBase->StbMLocalTimeClocks->StbMTimeCorrectionçš„é…ç½®ï¼š

   |image16|

   å›¾ StbMLocalTimeCorrectioné…ç½®ç•Œé¢

   StbMAllowMasterRateCorrectionå¦‚æœä¸»èŠ‚ç‚¹å¯ç”¨correctionåŠŸèƒ½åˆ™éœ€è¦å¼€å¯ã€‚

   StbMMasterRateDeviationMaxå¡«å†™ç”±
   StbM_SetRateCorrectionï¼ˆï¼‰è®¾ç½®çš„é€Ÿç‡åå·®å€¼çš„æœ€å¤§å…è®¸ç»å¯¹å€¼ã€‚

   StbMOffsetCorrectionAdaptionIntervalå¡«å†™é€‚åº”æ€§çš„é€Ÿç‡çŸ«æ­£è¶³ä»¥æ¶ˆé™¤é€Ÿç‡å’Œæ—¶é—´åå·®å€¼çš„æ—¶é—´åŒºé—´ã€‚

   StbMOffsetCorrectionJumpThresholdç”¨äºå†³å®šä½¿ç”¨ä»€ä¹ˆæ ·çš„çŸ«æ­£æ–¹å¼ã€‚åå·®å€¼è‹¥å°äºæ­¤å€¼ï¼Œåˆ™åœ¨å®šä¹‰çš„æ—¶é—´å‘¨æœŸå†…ä½¿ç”¨çº¿æ€§ç¼©å‡ï¼ˆlinear
   reductionï¼‰çŸ«æ­£ã€‚è‹¥å¤§äºæ­¤å€¼ï¼Œåˆ™ä»¥è·³è·ƒçš„æ–¹å¼ç«‹å³è®¾ç½®æ­£ç¡®çš„æ—¶é—´å’Œé€Ÿç‡ã€‚

   StbMRateCorrectionMeasurementDurationå¡«å†™ç”¨äºè®¡ç®—é€Ÿç‡å·®çš„æ—¶é—´åŒºé—´ã€‚

   StbMRateCorrectionsPerMeasurementDurationå¡«å†™åŒæ—¶è¿›è¡Œé€Ÿç‡æµ‹é‡çš„æ¬¡æ•°ï¼Œä»¥ç¡®å®šå½“å‰é€Ÿç‡åå·®ã€‚

EthTSynæ¨¡å—é…ç½®
~~~~~~~~~~~~~~~

#. åŒå‡»EthTSynæ¨¡å—ï¼Œæ‰“å¼€EthTSynæ¨¡å—çš„é…ç½®ç•Œé¢ã€‚

   |image17|

   å›¾ EthTSynGeneralé…ç½®ç•Œé¢

#. åœ¨EthTSynGeneralä¸‹ï¼Œæ¯ä¸ªé€‰é¡¹å…·ä½“æ³¨é‡Šæ„æ€å¯åœ¨å³ä¸‹è§’æŸ¥æ‰¾ã€‚æ­¤å®¹å™¨ä¸‹éœ€è¦æ³¨æ„EthTSynDestPhyAddrï¼Œæ­¤å®¹å™¨å»ºç«‹æ—¶ç›®æ ‡çš„MACåœ°å€ä¼šé»˜è®¤ä¸º01:80:C2:00:00:0Eï¼ˆæ­¤åœ°å€ä¸ºå¤šæ’­åœ°å€ï¼Œæ”¯æŒå¤šMACä¸»èŠ‚ç‚¹æˆæ—¶ï¼‰ï¼Œæ­¤å¤„éœ€è¦å®¢æˆ·æŒ‰æ•´è½¦åˆ†é…åœ°å€é‡æ–°å¡«å†™ã€‚

#. åœ¨EthTSynGlobalTimeDomainä¸‹ï¼Œå³é”®æ–°å»ºä¸¤ä¸ªä»¥å¤ªç½‘æ—¶é—´åŸŸï¼Œä¸€ä¸»ä¸€ä»ã€‚

   DomainIdé…ç½®å¯ä¸º0~31ï¼ŒEthTSynSynchronizedTimeBaseRefæ­¤å¤„å¼•ç”¨StbMæ¨¡å—ä¸­é…ç½®çš„ä¸»æˆ–è€…ä»ã€‚

   |image18|

   å›¾ EthTSynGlobalTimeDomainé…ç½®ç•Œé¢

#. åœ¨EthTSynGlobalTimeSlaveä¸‹ï¼ŒEthTSynRxCrcValidatedé€‰æ‹©æ— CRCæ ¡éªŒæ¨¡å¼ï¼ŒEthTSynGlobalTimeFollowUpTimeouté…ç½®ä¸º300msã€‚EthTSynGlobalTimeSequenceCounterJumpWidthè®¾ç½®ä¸º1ï¼Œå°†æ£€æŸ¥ä¸¤ä¸ªè¿ç»­åŒæ­¥ä¹‹é—´çš„
   SC
   å€¼è·³è½¬ã€‚EthTSynGlobalTimeSequenceCounterHysteresisè‹¥å‘ç”Ÿè¶…æ—¶ï¼Œåœ¨è½¬å‘æœ‰æ•ˆæ—¶é—´ä¹‹å‰ï¼Œè‡³å°‘è¦éªŒè¯çš„Sync-Follow
   Upæ¶ˆæ¯å¯¹ä¸ªæ•°ã€‚

   |image19|

   å›¾ EthTSynGlobalTimeSlaveé…ç½®ç•Œé¢

#. åœ¨EthTSynGlobalTimeMasterä¸‹ï¼ŒEthTSynRxCrcValidatedé€‰æ‹©æ— CRCæ ¡éªŒæ¨¡å¼ï¼ŒEthTSynCyclicMsgResumeTimeé…ç½®ä¸º500msï¼ŒEthTSynGlobalTimeTxPeriodé…ç½®ä¸º1sï¼ŒEthTSynImmediateTimeSyncé€‰æ‹©ä¸ºTRUEã€‚

   |image20|
   
   å›¾ EthTSynGlobalTimeMasteré…ç½®ç•Œé¢

#. åœ¨EthTSynPortConfigä¸‹ï¼Œ
   EthTSynGlobalTimeDebounceTimeé…ç½®ä¸º10msï¼ŒEthTSynGlobalTimeEthIfRefæ­¤å¤„å¼•ç”¨Ethifé…ç½®çš„Ethé©±åŠ¨æ¨¡å—ã€‚

   |image21|

   å›¾ EthTSynPortConfigé…ç½®ç•Œé¢

æºä»£ç é›†æˆ
----------

é¡¹ç›®äº¤ä»˜ç»™ç”¨æˆ·çš„å·¥ç¨‹ç»“æ„å¦‚ä¸‹ï¼š

   |image22|

   å›¾ å·¥ç¨‹ç»“æ„ç›®å½•

- Bsw_Configç›®å½•ï¼Œè¿™ä¸ªç›®å½•ç”¨æ¥å­˜æ”¾é…ç½®å·¥å…·ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ï¼ŒEthIfã€StbMã€EthTSynæœ‰å…³çš„é…ç½®æ–‡ä»¶æ”¾åœ¨Bsw_Configæ–‡ä»¶å¤¹ä¸‹ã€‚

- BSWç›®å½•ï¼Œå­˜æ”¾BSWç›¸å…³æ¨¡å—çš„æºä»£ç .

åè®®æ ˆè°ƒåº¦é›†æˆ
--------------

.. code-block:: c
   :linenos:
   :emphasize-lines: 6-10, 20-23, 26, 28-35, 47-48, 51-61

   #include <machine/wdtcon.h>
   #include "Mcu.h"
   #include "Port.h"

   // EthTSynåè®®æ ˆç›¸å…³æ¨¡å—å¤´æ–‡ä»¶
   #include "Eth_17_GEthMac.h"
   #include "EthIf.h"
   #include "Gpt.h"
   #include "StbM.h"
   #include "EthTSyn.h"

   int main(void)
   {
       // ä½¿èƒ½å®šæ—¶å™¨é€šçŸ¥å¹¶å¯åŠ¨å®šæ—¶å™¨
       Gpt_EnableNotification(GptConf_GptChannel_Gpt_1ms);
       Gpt_StartTimer(GptConf_GptChannel_Gpt_1ms, 100000);
       Gpt_StartTimer(GptChannelConfiguration_STBM, 0xFFFFFFu);

       // åˆå§‹åŒ–Ethã€EthIfã€EthTSynã€StbMæ¨¡å—
       StbM_Init(&StbM_Config);
       Eth_17_GEthMac_Init(&Eth_17_GEthMac_Config);
       EthIf_Init(&EthIf_ConfigData);
       EthTSyn_Init(&EthTSyn_Config);

       // æ‰“å¼€é€šä¿¡ï¼ˆä¸»èŠ‚ç‚¹ä½¿ç”¨ï¼‰
       EthTSyn_SetTransmissionMode(0, ETHTSYN_TX_ON);

       StbM_TimeStampType test1 = {0u};
       StbM_UserDataType test2 = {0u};

       // ä½œä¸»èŠ‚ç‚¹éœ€è¦æ·»åŠ åˆå§‹åŒ–æˆæ—¶
       test1.secondsHi = 0;
       test1.seconds = 1696903810;  // åˆå§‹æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
       test1.nanoseconds = 0;       // åˆå§‹æ—¶é—´æˆ³ï¼ˆçº³ç§’ï¼‰
       StbM_SetGlobalTime(0, &test1, &test2);

       while (1)
       {
           if (Gpt_1msFlag == TRUE)
           {
               Gpt_1msFlag = FALSE;
           }

           if (Gpt_10msFlag == TRUE)
           {
               // EthTSynã€StbMæ¨¡å—å‘¨æœŸå¤„ç†å‡½æ•°
               EthTSyn_MainFunction();
               StbM_MainFunction();

               // è·å–å½“å‰æ—¶é—´å¹¶å¡«å……åˆ°PduInfo
               StbM_GetCurrentTime(0, &timestamp, &userData);
               PduInfo.sdu[0] = (uint8)((StbM_TimeStamp.seconds & 0xff000000) >> 24);
               PduInfo.sdu[1] = (uint8)((StbM_TimeStamp.seconds & 0x00ff0000) >> 16);
               PduInfo.sdu[2] = (uint8)((StbM_TimeStamp.seconds & 0x0000ff00) >> 8);
               PduInfo.sdu[3] = (uint8)((StbM_TimeStamp.seconds & 0x000000ff));
               PduInfo.sdu[4] = (uint8)((StbM_TimeStamp.nanoseconds & 0xff000000) >> 24);
               PduInfo.sdu[5] = (uint8)((StbM_TimeStamp.nanoseconds & 0x00ff0000) >> 16);
               PduInfo.sdu[6] = (uint8)((StbM_TimeStamp.nanoseconds & 0x0000ff00) >> 8);
               PduInfo.sdu[7] = (uint8)((StbM_TimeStamp.nanoseconds & 0x000000ff));

               Can_Write(2, &PduInfo);  // ä»èŠ‚ç‚¹ï¼šè½¬å‘åŒæ­¥æ—¶é—´æŠ¥æ–‡ï¼ˆID=0x666ï¼‰
           }
       }
       return 1;
   }

éªŒè¯ç»“æœ
--------

æ ¹æ®é›†æˆç›®æ ‡ï¼Œèƒ½å¤Ÿè·ŸCANoeæ­£å¸¸é€šä¿¡ï¼Œä»¥ä¸‹æ˜¯éªŒè¯æ•ˆæœï¼Œå³ä¾§ä¸ºä»¥å¤ªç½‘æŠ¥æ–‡ï¼Œå·¦ä¾§ä¸ºCANè½¬å‘çš„StbMæ¨¡å—åŒæ­¥æ—¶é—´æˆ³å‰4ä¸ªå­—èŠ‚ä¸ºsï¼Œå4ä¸ªå­—èŠ‚ä¸ºnsã€‚

   |image23|

   å›¾ æ—¶é—´åŒæ­¥æ¨¡å—éªŒè¯ç»“æœ

.. |image1| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image2.png
   :width: 5.76736in
   :height: 2.9125in


.. |image2| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image3.png
   :width: 5.76736in
   :height: 2.9125in


.. |image3| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image4.png
   :width: 5.76736in
   :height: 3.9125in


.. |image4| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image5.png
   :width: 5.76736in
   :height: 3.9125in


.. |image5| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image6.png
   :width: 5.76736in
   :height: 2.9125in


.. |image6| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image7.png
   :width: 5.76736in
   :height: 2.9125in


.. |image7| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image8.png
   :width: 5.76736in
   :height: 4.2125in


.. |image8| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image9.png
   :width: 5.76736in
   :height: 4.9125in


.. |image9| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image10.png
   :width: 4.76736in
   :height: 1.9125in


.. |image10| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image11.png
   :width: 5.76736in
   :height: 3.9125in


.. |image11| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image12.png
   :width: 5.76736in
   :height: 2.9125in


.. |image12| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image13.png
   :width: 12.76736in
   :height: 5.9125in


.. |image13| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image14.png
   :width: 5.76736in
   :height: 2.9125in


.. |image14| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image15.png
   :width: 7.76736in
   :height: 4.9125in


.. |image15| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image16.png
   :width: 9.76736in
   :height: 3.4825in


.. |image16| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image17.png
   :width: 6.96736in
   :height: 2.9125in


.. |image17| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image18.png
   :width: 5.76736in
   :height: 2.4825in

.. |image18| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image19.png
   :width: 5.76736in
   :height: 2.9125in


.. |image19| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image20.png
   :width: 5.76736in
   :height: 2.9125in


.. |image20| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image21.png
   :width: 5.76736in
   :height: 2.9125in


.. |image21| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image22.png
   :width: 5.76736in
   :height: 2.9125in


.. |image22| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image23.png
   :width: 4.76736in
   :height: 3.9125in


.. |image23| image:: /_static/é›†æˆæ‰‹å†Œ/é›†æˆæ‰‹å†Œ_EthTSyn/image24.png
   :width: 5.76736in
   :height: 2.9125in
